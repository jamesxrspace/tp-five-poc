## Server-Sent-Event(SSE)

This document describes how SSE works, and demonstrates how to define SSE operations using OpenAPI and how to use the code generated by OpenAPI Code Generator to communicate with server. 

Suppose that we are developing a game and the game server provides an API that will stream down various game-related state updates to clients as they demand it. Now, if one client has invoked that API, it may receive the following http response and events from the game server:

```HTTP
HTTP/1.1 200 OK
Content-Type: text/event-stream
Date: Thu, 26 Oct 2023 05:57:18 GMT

event:item_pack_update
data:{"ItemId":101, "Count":25}

event:quest_update
data:{"QuestId":"Q101", "Stage":2}

event:activity_update
data:{"ActivityId":"A202", "IsActive":true}

```
Note that the <b>"Content-Type"</b> of SSE response is always <b>"text/event-stream"</b> and each event consists of two elements, delimited by newline characters. The first element starts with <b>"event:"</b> denoting the event name and the second one starts with <b>"data:"</b> containing the content of the event. The number and order of events in the SSE stream is solely controlled by server and when it completes its task, it closes the underlying connection.

### Define SSE operation in OpenAPI doc

We can define the fictitious API using the following OpenAPI doc: 

```yaml
paths:
  /api/v1/game/update:
    get:
      summary: get a stream of various game updates
      operationId: GetUpdateStream
      tags: [Game]
      security: [BearerAuth: []]
      x-is-sse: true
      responses:
        "200":
          description: OK
          content:
            application/json:
              schema:
                $ref: '../Common/common.yaml#/components/schemas/BaseResponse'
        "201":
          description: item pack update
          x-event: item_pack_update
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ItemPackUpdate'
        "202":
          description: quest update
          x-event: quest_update
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/QuestUpdate'
        "203":
          description: activity update
          x-event: activity_update
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ActivityUpdate'
...
components:
  schemas:
    ItemPackUpdate:
      type: object
      properties: 
        item_id:
          type: integer
          description: id of the target item
        count:
          type: integer
          description: new amount of the target item
    QuestUpdate:
      type: object
      properties: 
        quest_id:
          type: string
          description: id of the target quest
        stage:
          type: integer
          description: new stage of the target quest
    ActivityUpdate:
      type: object
      properties: 
        activity_id:
          type: string
          description: id of the target activity
        is_active:
          type: boolean
          description: the flag indicating whether the target activity is active or not
          
```

Note that:
- "<b>x-is-sse: true</b>" is used to mark the operation being a SSE API.
- The type of SSE response (status code (200)) is always <b>BaseResponse</b> and can't be something else.
- The responses other than the one of status code(200) are used here to define events and the type of their corresponding content. The status code '20X' is irrelevant and just used to distinguish the different events.
- The "<b>x-event: <event_name></b>" of each "event" response is used to denote the name of the event it defines.

### SSE Code Generated 

The OpenAPI code generator will generate the following C# code automatically based on the above-mentioned OpenAPI doc:

```C#
public interface IGameApi
{
    /// <summary>
    /// get a stream of various game updates 
    /// </summary>
    /// <returns>Task<BaseResponse></returns>
    ISSESource GetUpdateStream(RequestConfig requestConfig = default);        
}
```

And then we can use the generated code like this:

```C#
IGameApi gameApi = ...;
// Invoke the API
var sseSrc = gameApi.GetUpdateStream(...);
// Register event handlers with the ISSESource
sseSrc.RegisterEventHandler<ItemPackUpdate>("item_pack_update", (evtName, evt) => ...));
sseSrc.RegisterEventHandler<QuestUpdate>("quest_update", (evtName, evt) => ...));
sseSrc.RegisterEventHandler<ActivityUpdate>("activity_update", (evtName, evt) => ...));
// Register callbacks
sseSrc.OnError += (ex) => ...);
sseSrc.OnFinish += (resp) => ...);
...
// Dispose the ISSESource as it's done its job.
sseSrc.Dispose()
```
